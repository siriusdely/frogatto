{
id: "milgram",
prototype: ["hittable"],
solid_dimensions: ["boss"],
collide_dimensions: ["player","~enemy","~hazard"],
always_active: true,
friction: 1000,
traction: 1000,
hitpoints: 6000,
solid_area: [17,15,47,65],

properties: {
	flinch_threshold: "99999999",
	points_value: 10000,
	armor: "40",
	team: "'evil'",
	setup: "[	if( (not higher_difficulty), set(max_hitpoints, 2800)) ]", 
	attack_damage: "if(higher_difficulty,4,2)",
	
	choose_action: "if(size(_action_queue) > 0,[set(me.animation, (string <- head(_action_queue))), set(_action_queue, if(lib.standardize.tail(_action_queue), ([string] <- lib.standardize.tail(_action_queue)), populate_action_queue))], set(_action_queue,populate_action_queue))",
	
	populate_action_queue: "shuffle(	(['charge_homing'] * 3) + 
										(['charge_missile'] * if(higher_difficulty,3,1)) +
										(['charge_jump'] * if(higher_difficulty,1,3)) +
										(['walk'] * if(higher_difficulty,3,6)))",
	desired_facing: "if(level.player.mid_x < mid_x, -1, 1)",
	handle_knockback: "def(obj hittable collide_with) -> commands null",
	charge_duration: "30",
	springiness: "140",
	
	become_hostile: "[ set(_passive, false), set(solid_dimensions_in, ['boss']), set(collide_dimensions_in, ['player','~enemy','~hazard']) ]",
	become_passive: "[ set(_passive, true), set(solid_dimensions_in, []), set(collide_dimensions_in, []), ]",


#-------------------------- vars --------------------------#
	_passive: { type: "bool", default: true, persistent: false },
	_charge_counter: { type: "int", default: 0, persistent: false },
	_mutter_counter: { type: "int", default: 3, persistent: false },
	_action_queue: { type: "[string]", default: [], persistent: false },
},

#-------------------------- basic animations --------------------------#
on_end_walk_anim: "if(_passive, set(animation, 'walk'), choose_action)",
on_end_stand_anim: "if(_passive, set(animation, 'stand'), choose_action)",
on_end_hurt_anim: "animation('stand')",
on_footfall: "sound_falloff('footstep-heavy'+1d6+'.wav')",

#-------------------------- collision handling --------------------------#
on_collide_side: "if(arg.collide_with != level.player, [set(velocity_x, -velocity_x/2), set(facing, -facing)])",
on_collide_feet: "[set(velocity_x, 0), 
			if(velocity_y > 800, 
					[animation('crush'), shake_screen(200, 200, 100, 100), sound_falloff('thump-deep.wav'),
					spawn('milgram.ground_slash',mid_x+18*facing,mid_y+45,facing, set(child.velocity_x,800*facing)),
					spawn('milgram.ground_slash',mid_x-9*facing,mid_y+45,-facing, set(child.velocity_x,-800*facing)),
					spawn('milgram.ground_slam',mid_x+10*facing,mid_y-70,facing)],
			animation('stand'))]",

#-------------------------- attack handling --------------------------#
on_enter_charge_jump_anim: "set(velocity_x,0)",
on_end_charge_jump_anim: "set(animation, 'jump')",
on_end_jump_anim: "set(animation, 'fall')",

on_enter_crush_anim: "[set(velocity_x,0)]",
on_end_crush_anim: "[set(animation, 'stand'),spawn('milgram.decorative_crumble',1040,700,1)]",

on_process_charge_missile: "if(time_in_animation = 30, [set(animation, 'fire_missile'),set(_charge_counter,0),fire_event('fire_missile')])",
on_end_charge_missile_anim: "set(animation, 'walk')",
on_end_fire_missile_anim: "if(_charge_counter < charge_duration, [animation('fire_missile'), add(_charge_counter,1)], [set(animation, 'charge_missile'), set(time_in_animation, 31)])",
on_fire_missile: "[
	   spawn('milgram.guided_missile', img_mid_x + facing*80, img_mid_y - 55, 1),sound_falloff('milgram-chargeup.wav')]",
on_process_charge_homing: "if(time_in_animation = 48, set(animation, 'fire_homing'))",

on_end_charge_homing_anim: "set(animation, 'walk')",
on_end_fire_homing_anim: "[
	   spawn('milgram.energy_shot', img_mid_x + facing*60, img_mid_y + 16, facing, [set(child.velocity_x, facing*500), set(child.velocity_y, 20)]),
	   spawn('milgram.energy_shot', img_mid_x + facing*60, img_mid_y + 16, facing, [set(child.velocity_x, facing*400), set(child.velocity_y, 100)]),
	   spawn('milgram.energy_shot', img_mid_x + facing*60, img_mid_y + 16, facing, [set(child.velocity_x, facing*400), set(child.velocity_y, -100)]),
	   set(animation, 'charge_homing'), set(time_in_animation, 49),sound_falloff('milgrambreath.wav')]",
	   
#-------------------------- cutscene/emote anims --------------------------#	   
on_end_emote_laugh_anim: "animation('stand')",
on_end_emote_pensive_anim: "animation('stand')",
on_end_emote_talk_anim: "animation('stand')",
on_end_emote_angry_anim: "animation('stand')",
on_end_emote_assertive_anim: "animation('stand')",
on_beaten_up_mutter: "[set(_mutter_counter,3),animation('beaten_up_talk')]",
on_end_beaten_up_idle_anim: "animation('beaten_up_idle')",
on_end_beaten_up_talk_anim: "if(_mutter_counter > 0, [add(_mutter_counter,-1),animation('beaten_up_talk')] ,animation('beaten_up_idle'))",
on_get_up: "[animation('get_up'),set(time_in_animation,121)]",
on_end_get_up_anim: "animation('stand')",


editor_info: {
	category: "enemies, milgramen",
},
animation: [
	{
		image: "enemies/milgram-spritesheet1.png",
		id: "stand",
		rect: [8,7,70,74],
		duration: 5,
		frames: 5,
		frames_per_row: 5,
		pad: 3,
		reverse: true,
		body_area: "all",
		accel_x: 0,
	},
	{
		image: "enemies/milgram-spritesheet1.png",
		id: "hurt",
		rect: [8,7,70,74],
		duration: 5,
		frames: 5,
		frames_per_row: 5,
		pad: 3,
		reverse: true,
		body_area: "all",
		accel_x: 0,
	},
	{
		image: "enemies/milgram-spritesheet0.png",
		id: "walk",
		accel_x: 500,
		rect: [1,1,63,68],
		events: "5:25:footfall",
		duration: 5,
		frames: 8,
		pad: 2,
		attack_area: [0,30,62,66],
		body_area: "all",
	},
	{
		image: "enemies/milgram-spritesheet1.png",
		id: "charge_jump",
		rect: [4,150,72,226],
		duration: 6,
		frames: 2,
		pad: 3,
		body_area: "all",
		attack_area: "all",
		solid_area: [17,25,47,75],
	},
	{
		image: "enemies/milgram-spritesheet1.png",
		id: "jump",
		rect: [148,150,216,226],
		duration: 6,
		frames: 4,
		pad: 3,
		body_area: "all",
		attack_area: "all",
		accel_y: 80,

		#velocity_x=1000
		velocity_y: -2000,
		solid_area: [17,25,47,75],
	},
	{
		image: "enemies/milgram-spritesheet1.png",
		id: "fall",
		rect: [427,45,495,121],
		duration: 8,
		frames: 1,
		pad: 3,
		accel_y: 400,
		solid_area: [17,25,47,75],
		body_area: "all",
		attack_area: "all",
	},
	{
		image: "enemies/milgram-spritesheet1.png",
		id: "crush",
		accel_x: 0,
		rect: [404,232,480,308],
		duration: 8,
		frames: 2,
		pad: 3,
		reverse: true,
		frames_per_row: 1,
		accel_y: 80,
		solid_area: [17,25,47,75],
		body_area: "all",
		attack_area: "all",
	},
	{
		image: "enemies/milgram-spritesheet1.png",
		id: "charge_homing",
		accel_x: 0,
		rect: [2,231,98,317],
		duration: 6,
		frames: 8,
		frames_per_row: 4,
		pad: 3,
		reverse: true,
		solid_area: [32,34,62,84],
		body_area: "all",
	},
	{
		image: "enemies/milgram-spritesheet1.png",
		id: "fire_homing",
		rect: [2,422,98,508],
		duration: 6,
		frames: 1,
		frames_per_row: 4,
		pad: 3,
		reverse: false,
		solid_area: [32,34,62,84],
		body_area: "all",
	},
	{
		image: "enemies/milgram-spritesheet1.png",
		id: "charge_missile",
		accel_x: 0,
		rect: [102,419,179,486],
		duration: 10,
		frames: 3,
		pad: 3,
		reverse: true,
		solid_area: [17,15,47,65],
		body_area: "all",
	},
	{
		image: "enemies/milgram-spritesheet1.png",
		id: "fire_missile",
		rect: [340,3,417,70],
		duration: 2,
		frames: 2,
		frames_per_row: 1,
		pad: 3,
		reverse: false,
		solid_area: [17,15,47,65],
		body_area: "all",
	},
	{
		image: "enemies/milgram-spritesheet2.png",
		id: "emote_talk",
		rect: [424,2,486,69],
		duration: 6,
		frames: 7,
		frames_per_row: 1,
		pad: 3,
		reverse: true,
		body_area: "all",
		accel_x: 0,
	},
	{
		image: "enemies/milgram-spritesheet2.png",
		id: "emote_laugh",
		rect: [1,1,73,78],
		duration: 8,
		frames: 9,
		frames_per_row: 3,
		pad: 3,
		reverse: true,
		body_area: "all",
		accel_x: 0,
		solid_area: [22,25,52,75],
	},
	{
		image: "enemies/milgram-spritesheet3.png",
		id: "emote_pensive",
		rect: [2,165,74,242],
		duration: 8,
		frames: 15,
		frames_per_row: 5,
		pad: 3,
		body_area: "all",
		accel_x: 0,
		solid_area: [22,25,52,75],
	},
	{
		image: "enemies/milgram-spritesheet2.png",
		id: "emote_assertive",
		rect: [2,255,74,332],
		duration: 8,
		frames: 15,
		frames_per_row: 5,
		pad: 3,
		body_area: "all",
		accel_x: 0,
		solid_area: [22,25,52,75],
	},
	{
		image: "enemies/milgram-spritesheet3.png",
		id: "emote_angry",
		rect: [2,1,82,78],
		duration: 8,
		frames: 12,
		frames_per_row: 6,
		pad: 3,
		body_area: "all",
		accel_x: 0,
		solid_area: [15,25,45,75],
	},
	{
		image: "enemies/milgram-spritesheet2.png",
		id: "beaten_up_idle",
		rect: [230,1,314,56],
		duration: 30,
		frames: 1,
		pad: 3,
		body_area: "all",
		accel_x: 0,
		solid_area: [17,5,47,55],
	},
	{
		image: "enemies/milgram-spritesheet1.png",
		id: "get_up",
		accel_x: 0,
		rect: [2,231,98,317],
		duration: 12,
		frames: 8,
		frames_per_row: 4,
		pad: 3,
		reverse: true,
		solid_area: [32,34,62,84],
		body_area: "all",
	},
	{
		image: "enemies/milgram-spritesheet2.png",
		id: "beaten_up_talk",
		rect: [230,1,314,56],
		duration: 8,
		frames: 2,
		pad: 3,
		body_area: "all",
		accel_x: 0,
		solid_area: [17,5,47,55],
	},
],
object_type: [
	{
		id: "ground_slash",
		zorder: "@include data/zorder.cfg:near_player_foreground_effects",
		dies_on_inactive: true,
		properties: {
			attack_damage: 2,
		},
		on_end_normal_anim: "animation('fadeout')",
		on_end_fadeout_anim: "die()",
		always_active: true,
		object_level_collisions: false,
		prototype: ["shot"],

		#on_die="spawn('milgram.energy_shot_splash',mid_x,mid_y,facing)"
		on_create: "add_particles('particles')",
		animation: [
			{
				image: "effects/milgramshots.png",
				pad: 3,
				id: "normal",
				attack_area: "all",
				rect: [1,164,46,196],
				frames: 3,
				duration: 3,
			},
			{
				image: "effects/milgramshots.png",
				pad: 3,
				id: "fadeout",
				rect: [1,200,46,232],
				frames: 3,
				duration: 2,
			},
		],
		particle_system: {
			id: "particles",
			type: "point",
			generation_rate_millis: 500,
			time_to_live: 12,
			time_to_live_rand: 24,
			colors: ["fff3d7ff","eec6ffff","eec6ffff","ff85fbff","b0009a55"],
			pos_x: 20,
			pos_y: 20,
			pos_x_rand: 32,
			pos_y_rand: 32,
			velocity_x: -1500,
			velocity_x_rand: 3000,
			velocity_y: -200,
			velocity_y_rand: 400,
		},
	},
	{
		id: "ground_slam",
		zorder: "@include data/zorder.cfg:in_front_of_everything",
		dies_on_inactive: true,
		properties: {
			attack_damage: 2,
		},
		on_end_normal_anim: "die()",
		always_active: true,
		object_level_collisions: false,
		prototype: ["shot"],
		animation: {
			image: "effects/milgramshots2.png",
			pad: 3,
			id: "normal",
			attack_area: "all",
			rect: [1,1,121,158],
			frames: 6,
			frames_per_row: 3,
			duration: 2,
		},
	},
	{
		id: "guided_missile",
		zorder: "@include data/zorder.cfg:near_player_foreground_effects",
		traction_in_air: 1000,
		friction: 1000,
		properties: {
			attack_damage: 2,
			movement_speed: 6,
			rotation_schedule_base: "[0, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200, 220, 240, 260, 280, 300, 320, 340]",

		#-------------------------- vars --------------------------#
			_is_hostile: { type: "bool", default: false, persistent: false },
			_charge_counter: { type: "int", default: 0, persistent: false },
			_time_to_live: { type: "int", default: 60, persistent: false },
		},
		on_end_normal_anim: "set(animation, 'normal')",
		always_active: true,
		object_level_collisions: false,
		prototype: ["shot"],
		on_die: "[spawn('milgram.energy_shot_splash',mid_x,mid_y,facing), sound_falloff('milgramfire-Hit.wav')]",
		on_create: "[set(rotation_schedule, rotation_schedule_base), add_particles('particles'), fire_event('timer'), schedule(100,set(_is_hostile,true)), spawn('milgram.guided_missile_ring',mid_x,mid_y,facing,[set(child.parent,me)]), spawn('milgram.guided_missile_ring',mid_x,mid_y,facing,[set(child.parent,me)]), spawn('milgram.guided_missile_ring',mid_x,mid_y,-facing,[set(child.parent,me)])]",
		timer_frequency: 25,
		on_timer: "[if(_is_hostile,
	 [set(accel_x, movement_speed*if(mid_x < level.player.mid_x, 1, -1)),
	 set(accel_y, movement_speed*if(mid_y < level.player.mid_y, 1, -1)),
	 add(_time_to_live, -1), if(_time_to_live <= 0, die()),
	 	if(cycle%100 > 60,sound_falloff('milgram-homingshot-buzz.wav')) ])]",
		animation: {
			id: "normal",
			image: "effects/milgramshots.png",
			x: 121, y: 1, w: 19, h: 19,
			pad: 3,
			frames: 5,
			frames_per_row: 1,
			duration: 3,
			attack_area: "all",
		},
		particle_system: {
			id: "particles",
			type: "point",
			generation_rate_millis: 500,
			time_to_live: 12,
			time_to_live_rand: 24,
			colors: ["fff3d7ff","eec6ffff","eec6ffff","ff85fbff","b0009a55"],
			pos_x: 2,
			pos_y: 2,
			pos_x_rand: 20,
			pos_y_rand: 20,
			dot_size: 2,
			velocity_x: -1500,
			velocity_x_rand: 3000,
			velocity_y: -1500,
			velocity_y_rand: 3000,
		},
	},
	{
		id: "guided_missile_ring",
		always_active: true,
		zorder: "@include data/zorder.cfg:near_player_foreground_effects",
		zsub_order: 1,
		properties: {
		#-------------------------- vars --------------------------#
			_random_seed: { type: "int", init: "1d2", persistent: false },
			_random_seed2: { type: "int", init: "1d30", persistent: false },
		},


		on_create: "[set(animation, 'normal'+1d3),set(relative_x,0),set(relative_y,0)]",
		on_end_anim: "set(animation,'normal'+1d3)",
		on_process: "[ set(rotate, sin(_random_seed2 + cycle * 1.0/(2+_random_seed))*360), if(parent != null, if(parent.hitpoints = 0,die()), die()) ]",
		animation: [{
			id: "normal1",
			image: "effects/milgramshots.png",
			x: 143, y: 1, w: 25, h: 25,
			pad: 3,
			frames: 10,
			frames_per_row: 2,
			duration: 3,
		},
		{
			id: "normal2",
			image: "effects/milgramshots.png",
			x: 143, y: 1, w: 25, h: 25,
			pad: 3,
			frames: 10,
			frames_per_row: 2,
			duration: 4,
		},
		{
			id: "normal3",
			image: "effects/milgramshots.png",
			x: 143, y: 1, w: 25, h: 25,
			pad: 3,
			frames: 10,
			frames_per_row: 2,
			duration: 5,
		}],
	},
	{
		id: "energy_shot",
		zorder: "@include data/zorder.cfg:near_player_foreground_effects",
		dies_on_inactive: true,
		properties: {
			attack_damage: 2,
			team: "'evil'",
		},
		on_end_normal_anim: "set(animation, 'normal')",
		always_active: true,
		object_level_collisions: false,
		prototype: ["shot"],
		on_die: "[spawn('milgram.energy_shot_splash',mid_x,mid_y,facing),sound_falloff('milgramfire-Hit.wav')]",
		on_create: "add_particles('particles')",
		animation: [
			{
				attack_area: "all",
				image: "effects/milgramshots.png",
				w: 37,
				h: 37,
				pad: 3,
				frames: 3,
				duration: 2,
				id: "normal",
				x: 1,
				y: 1,
			},
			{
				attack_area: "all",
				image: "effects/milgramshots.png",
				w: 37,
				h: 37,
				pad: 3,
				frames: 3,
				duration: 2,
				id: "normal",
				x: 1,
				y: 41,
			},
		],
		particle_system: {
			id: "particles",
			type: "point",
			generation_rate_millis: 500,
			time_to_live: 12,
			time_to_live_rand: 24,
			colors: ["fff3d7ff","eec6ffff","eec6ffff","ff85fbff","b0009a55"],
			pos_x: 20,
			pos_y: 20,
			pos_x_rand: 32,
			pos_y_rand: 32,
			dot_size: 2,
			velocity_x: -1500,
			velocity_x_rand: 3000,
			velocity_y: -200,
			velocity_y_rand: 400,
		},
	},
	{
		id: "decorative_crumble",
		zorder: "@include data/zorder.cfg:near_player_foreground_effects",
		on_end_normal_anim: "[set(particle_systems['crumbles'].generation_rate, 0),animation('normal2')]",
		on_end_normal2_anim: "die()",
		always_active: true,
		on_create: "[add_particles('crumbles'), schedule(150,die())]",
		animation: [
			{
				image: "effects/milgramshots.png",
				rect: [0,0,1,1],
				frames: 1,
				id: "normal",
				duration: 20,
			},
			{
				image: "effects/milgramshots.png",
				rect: [0,0,1,1],
				frames: 1,
				id: "normal2",
				duration: 200,
			},
		],
		particle_system: {
			id: "crumbles",
			type: "point",
			generation_rate_millis: 500,
			time_to_live: 36,
			time_to_live_rand: 24,
			colors: ["ddddddff","ffffffff"],
			pos_x: -800,
			pos_y: 0,
			pos_x_rand: 1600,
			pos_y_rand: 0,
			velocity_x: 0,
			velocity_x_rand: 0,
			velocity_y: 1500,
			velocity_y_rand: 3500,
			accel_y: 100,
			dot_size: 3,
		},
	},
	{
		id: "energy_shot_splash",
		zorder: "@include data/zorder.cfg:near_player_foreground_effects",
		dies_on_inactive: true,
		on_end_normal_anim: "die()",
		always_active: true,
		animation: {
			image: "effects/milgramshots.png",
			w: 37,
			h: 37,
			pad: 3,
			frames: 6,
			frames_per_row: 3,
			duration: 4,
			id: "normal",
			x: 1,
			y: 82,
		},
	},
],
}
